# -*- cperl -*-
#
# beginnings of async test script
#

#*  uses
#
use DBI;
use DBD::Pg	':async';

#*  constants
#
#use constant CONNSPEC =>	sprintf('dbi:Pg:dbname=%s', $ENV{USER});
use constant CONNSPEC =>	'dbi:Pg:host=dbdpg-18793d83-dbdpg-test.l.aivencloud.com port=10056 dbname=defaultdb user=avnadmin password=XXXXXXXXXXXXXXXXXX';

#*  subs
#
sub msg
{
    my $msg;

    $msg = sprintf($_[0], @_[1 .. $#_]);
    print STDERR ($msg, "\n");
}

sub wait_for
{
    my ($fh, $what) = @_;
    my ($rin, $win, $vec, $nf);
    
    vec($vec, fileno($fh), 1) = 1;
    if ($what == PG_ASYNC_CONN_READ) {
        $rin = $vec;
    } else {
        $win = $vec;
    }

    $nf = select($rin, $win, undef, undef);
    msg('select returned %d', $nf);
}

sub dbh_connect
{
    my ($fh, $dbh, $rc);
    
    msg('connecting');

    $dbh = DBI->connect(CONNSPEC, '', '',
                               {
                                RaiseError => 1,
                                pg_server_prepare => 1,
                                pg_async_connect => 1});
    open($fh, '<&', $$dbh{pg_socket});

    do {
        $rc = $dbh->pg_continue_async_connect();
        msg('continue async connect %d', $rc);
        wait_for($fh, $rc) if $rc;
    } while $rc;

    msg('connected');

    return $dbh;
}

sub do_query
{
    my $dbh = $_[0];
    my ($fh, $sth, $rc);

    msg('querying');

    $sth = $dbh->prepare('select * from the_table where name = ?', { pg_async => 1 });
    $sth->execute('Ludwig');

    open($fh, '<&', $$dbh{pg_socket});

    do {
        wait_for($fh, PG_ASYNC_CONN_READ);
        $rc = $dbh->pg_ready();
    } until $rc;

    $dbh->pg_result();
    return $sth;
}

#*  main
#
{
    my ($dbh, $sth, $row);
    
#    DBI->trace(15);
    $dbh = dbh_connect();
    $sth = do_query($dbh);
    while ($row = $sth->fetchrow_arrayref()) {
        print("@$row", "\n");
    }
}
